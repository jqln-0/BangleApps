Graphics.prototype.setFontFiraSansCondensed = function(scale) {
  // Actual height 65 (64 - 0)
  this.setFontCustom(
    atob('AAAAAAAAAAAAAAAAAAAcAAAAAAAAAAP8AAAAAAAAAD/wAAAAAAAAA//AAAAAAAAAP/4AAAAAAAAB//AAAAAAAAAP/4AAAAAAAAB//AAAAAAAAAP/4AAAAAAAAA//AAAAAAAAAH/wAAAAAAAAAf+AAAAAAAAAB/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAAAAAAAAH4AAAAAAAAAP/AAAAAAAAAf/8AAAAAAAA///gAAAAAAD///8AAAAAAH////gAAAAAP////8AAAAAf/////wAAAA//////+AAAB///////wAAD///////gAAP///////AAAf//////+AAA///////8AAA///////wAAAH//////gAAAA//////AAAAAH////+AAAAAAf///8AAAAAAD///wAAAAAAAf//gAAAAAAAD//AAAAAAAAAP+AAAAAAAAAB8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf8AAAAAAAAH///wAAAAAAH////wAAAAAD/////gAAAAB//////AAAAAf/////8AAAAP//////wAAAB///////AAAAf//////8AAAH///////wAAA///////+AAAP///////4AAB//+AA///AAAP/wAAAH/4AAB/4AAAAP/AAAP+AAAAA/4AAB/wAAAAH/AAAP+AAAAA/4AAB/wAAAAH/AAAP/AAAAB/4AAB/8AAAAf/AAAP//AAB//4AAB////////AAAH///////wAAA///////+AAAD///////gAAAP//////4AAAB///////AAAAD//////gAAAAP/////4AAAAAf////+AAAAAB/////AAAAAAA///+AAAAAAAAP/4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAB4AAAAAAAAAAPgAAAAAAAAAD/AAAAAAAAAA/8AAAAAAAAAH/wAAAAAAAAB/8AAAAAAAAAf/gAAAAAAAAD/4AAAAAAAAA/+AAAAAAAAAP/wAAAAAAAAB/8AAAAAAAAAf/AAAAAAAAAH/4AAAAAAAAA///////+AAAH///////wAAA///////+AAAH///////wAAA///////+AAAH///////wAAA///////+AAAH///////wAAA///////+AAAH///////wAAA///////+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGAAAAAAAAAAB4AAAAP+AAAA/gAAAD/wAAAH+AAAA/+AAAB/wAAAP/wAAAf/AAAD/+AAAH/4AAA//wAAA//AAAP/+AAAH/gAAH//wAAB/8AAB//+AAAP/AAAf//wAAB/wAAH//+AAAP+AAD///wAAB/wAA///+AAAP+AAP///wAAB/wAH//v+AAAP/AD//5/wAAB/8B//+P+AAAP/////h/wAAB/////4P+AAAP////+B/wAAA/////gP+AAAH////wB/wAAA////8AP+AAAD////AB/wAAAP///gAP+AAAA///4AB/wAAAD//8AAP+AAAAP/+AAB/wAAAAP/AAAP+AAAAAAAAAB+AAAAAAAAAAAAAAAAIAAAAA4AAAADgAAAAPgAAAA+AAAAD+AAAAP4AAAA/4AAAB/gAAAH/gAAAf+AAAB/8AAAH/wAAAH/wAAA/8AAAA/+AAAH/AAAAD/4AAB/4AAwAP/AAAP+AH/AB/4AAB/wA/4AH/AAAP+AH/AA/4AAB/wA/4AH/AAAP+AH/AA/4AAB/wA/4AH/AAAP+AP/AB/4AAB/4D/8AP/AAAP/x//wD/4AAB////////AAAP///////4AAA///////+AAAH///////wAAA///7///+AAAD///f///gAAAP//5///4AAAB//+H///AAAAD//g///wAAAAP/wD//4AAAAAf4AP/+AAAAAAAAAf/AAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/8AAAAAAAAAf/gAAAAAAAAf/8AAAAAAAAf//gAAAAAAAP//8AAAAAAAP///gAAAAAAH///8AAAAAAH////gAAAAAH////8AAAAAD/////gAAAAD/////8AAAAB//////gAAAAf///+f8AAAAB////D/gAAAAP///Af8AAAAB///gD/gAAAAH//gAf8AAAAA//gAD/gAAAAD/wAf///wAAAfwB////+AAAD4AP////wAAAIAB////+AAAAAAP////wAAAAAB////+AAAAAAP////wAAAAAB////+AAAAAAP////wAAAAAB////+AAAAAAP////wAAAAAAAD/gAAAAAAAAAf8AAAAAAAAAD/gAAAAAAAAAf8AAAAAAAAAB/gAAAAAAAAAAAYAAAAAAAAAAHgAAAAAAAAAB+AAAA////wAf4AAAP///+AD/AAAB////wA/8AAAP///+AP/wAAB////wA/+AAAP///+AD/wAAB////wAf/AAAP///+AB/4AAB////gAH/AAAP///8AA/4AAB////AAH/AAAP+AP4AA/4AAB/wD/AAH/AAAP+Af4AA/4AAB/wD/gAP/AAAP+Af8AB/4AAB/wD/4A//AAAP+Af////4AAB/wD////+AAAP+Af////wAAB/wD////+AAAP+Af////gAAB/wB////4AAAP+AH////AAAB/wA////wAAAP+AD///8AAAA/gAP//+AAAAAAAAf//gAAAAAAAA//gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf//wAAAAAAA////wAAAAAAf////gAAAAAP/////AAAAAH/////8AAAAB//////wAAAAf//////AAAAH//////8AAAB///////wAAAf//////+AAAD///////wAAA////////AAAH//P+AP/4AAB//B/gAP/AAAP/gf4AA/4AAB/4D/AAH/AAAP+A/wAA/4AAB/wH+AAH/AAAP8A/4AA/4AAB/gH/gAP/AAAP8A//AP/4AAB/wH/////AAAP+A/////wAAB/wH////+AAAP/Af////wAAA/4D////8AAAH8AP////AAAAeAB////wAAADgAH///8AAAAAAAP///AAAAAAAA///gAAAAAAAA//wAAAAAAAAAGAAAAAAAAAAAAAAAAAP/AAAAAAAAAB/4AAAAAAAAAP/AAAAABAAAB/4AAAAA4AAAP/AAAAA/gAAB/4AAAA/8AAAP/AAAAf/gAAB/4AAAf/+AAAP/AAAP//wAAB/4AAP//+AAAP/AAP///4AAB/4AH////AAAP/AH////4AAB/4D////+AAAP/D////+AAAB/7/////AAAAP//////AAAAB//////gAAAAP/////gAAAAB/////gAAAAAP////wAAAAAB////wAAAAAAP///wAAAAAAB///4AAAAAAAP//4AAAAAAAB//4AAAAAAAAP/8AAAAAAAAB/8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAAAAB/8AAAAAB/gA//4AAAAA//AP//gAAAAf/8D//+AAAAH//4///4AAAB///v///gAAAf//9///8AAAD///////wAAA///////+AAAH///////wAAB////////AAAP////8H/4AAB/8f/+AP/AAAP+Af/AA/4AAB/gD/wAH/AAAP8AP/AA/4AAB/gA/4AH/AAAP8AH/gA/4AAB/gB/8AH/AAAP+Af/wA/4AAB/8f//AP/AAAP////8D/4AAB////////AAAH///////wAAA///////+AAAH///////wAAAf//7///8AAAB//+P///AAAAH//g///4AAAAf/4D//+AAAAB/+AP//gAAAAD/AA//4AAAAAAAAB/8AAAAAAAAAA4AAAAAAAMAAAAAAAAAA//gAAAAAAAA///AAAAAAAAP//+AAAAAAAD///4AD4AAAA////gAf4AAAP///+AD/gAAD////4A/8AAAf////AH/gAAH////4A/4AAA/////gP/AAAP////8B/4AAB//A//gf/AAAP/AA/8D/wAAB/wAD/g/+AAAP+AAf8P/gAAB/gAD/h/8AAAP8AAf4//gAAB/gAD/P/4AAAP+AA/z//AAAB/4AP///wAAAP/+D///+AAAB///////gAAAH//////4AAAA//////+AAAAH//////gAAAAf/////4AAAAB/////+AAAAAH/////gAAAAAf////wAAAAAB////8AAAAAAD///+AAAAAAAH//8AAAAAAAAD/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAcAAAAAAP8AAP8AAAAAD/wAD/wAAAAA//AA//AAAAAH/4AP/4AAAAB//AB//AAAAAP/8AP/4AAAAB//gB//AAAAAP/4AP/4AAAAA//AA//AAAAAH/wAH/wAAAAAf+AAf+AAAAAB/AAB/AAAAAAAAAAAAAAAAAAAAAAAAAA='),
    46,
    atob("ECAmHSAhIyIkHSQkEA=="),
    69+(scale<<8)+(1<<16)
  );
  return this;
}

Graphics.prototype.setFontHaxorNarrow = function(scale) {
  // Actual height 16 (15 - 0)
  this.setFontCustom(
    E.toString(require('heatshrink').decompress(atob("ABH/5k/+YVRh/AgfwBBoAEhgNBmEP//D//wBBgaEnkwj+Oh1x4cMmH//k//4FB4eOuFx/EMngaE+Ewnkch8OgfHgEDwEB4EA8fAuHwnE8hkPGovwj/+h154eemF/5kPn8Ag4fB8EA/kAmZwJFwNwgH4EoK4TE4N/wE4uEch0OgPDgCCFUpEA4eAuFwnEOjkB/0AKgIAImEwCIXOLoShDgHMgFzHwUMFYIADgZpDIgIMBn/wh5XBBAYREHZUAjkAn0AWYoANFhAIDACQdEGJxLBhzrBC4LtBGoLvBcAM4HI8P4EH/EDw4VB8Hgjk4g8HD4Ph4Ef8ED+A4IJAPA4EwXghuEJ5E8jkfh0O4cHmHDxgCBhgCBzkwv0Mh50FFwLzBhkB4YiBC4cM+HDv1w/P4nk8JgvAgJZB9kAuZ9B4AbBh//4f/BoJUH/kwn41B4PDHYPMhkzgcM4HDnFw4/4mH8UIvwg/+gex4PMmHjKAYCBh1wgP4gBQFHoZ3BQwJlBwExKQK3Ba4IZHAwPwj/+h15QYgCEz1wv/4h4bFAoMfwBEBC4vHNwODxvAv/gMgLbIAAkMhkDZwoAON4Mchk+gcPChopBgPgYILXBwC1BjkOhz7DI5PAgYMB5kAmYIODxEAXINwuE4h0cgPOgE/gEHwDRCMo0AhxWCDoPMmPza4ScBvAqCAAk/a4ZiD5/MmYaB5nD2cwv/AXg0P/kH/8DxgbC8HAnEwg4vB8bnB/kD/4aE//8n//d4gCGz1wv/4h88KBvAC4MDR4z9BGpIRBDRQ1Cc4JQTAQIjDDRQvDHA7UBeIxrNhnDwcwuH8hj3BGo4mCFgJECF4YIBCIgAHJoiPICxAKCh0AgIvFHAlw//4n6hJC4UegEP4EHnEDw4kB8HgjihKMo5uIDRIJC8EAj8Ag/AgeADYSGIBAgPBnAYBD4ccGAQaIa5qhBwFwv/4h6GJCgodFzkAvyRBXYo1J5kwn8Mg+DwPgv/8h/zGp3AmH4hk3GoPgv0ch6hFnkwj+Oh1x4YdBAQ2OuFxEIM8DQjIIHwjaHKAvwn/+gEBeRVw//4n6hFAoM/c4N8SgIEDeoM+AYQpBn41NuEA/AYCBAY1I+E8n0fgPOFAUHwEB8BDCueA/F8njYF+ArFnAaB/kB/8ADgI9DUAp3BXoUMh3Dg62BxkxXgPg4dwboU8a4oADh//4ZyB4D4FVQIIDCwi0BhxQGBYJOBjjABVQJTBEQJQEFhY+EJhAWBFwIpBG4QyBHJIbIBIQZBLAIINABbFGDIIAJBYMegHP4EzmEM5kDmcA5nAncwcAMAcAIAD//8n4IB4HAmAaBhkDI4IIBnFwg7zBDgIADgfwgP+gHhDRIIGDSpHEDRHtNZiLBbZKwEn/8j//hz+DABBQF5kwmZQB4cDmHABAM3h//wf/HAKhIeJM4gC8IAAh9D5/8mYRCeZoADGQMH5//2ZHFABhdB4f/SgIXBvCLBgEc8EOjjXGGYvDI4LOFKBcP/kDQwZ9DgIIB8CGLDQyhTa4qhCa4JiCVQM4uEH/EADgKCIXgYaRGp4IBV4oAHaAM/+AXBgJpBQwJ0GGokMgPjIAPAmY1B5kDmcA5gIB+EMvATBeZKhDIgM/LIPBKATXJJIIRBJQS9INYLODDQgQBMAMfAgccaIINBwEH4ADBgYgBGpdwgCzBnwIEh/4ga8FWYWHgFzwEP4EBG4N4gE/HYPgh0cYoQ1J5kAToMM4EDOAIIBm7XBwbMBGowjB4fAmKzB9kDuZUB4E8fYoAIFoMeJYPwj8+h0B4YLB4EMmAaKAAf8/k/NIIAMEYbRB4eAuF8/DQBRAQLBJZTPBhzWBwC9CAwLEEnAeH/5HB/6TB4f/+AIMLJoARA="))),
    33, 12, 18
  );
  return this;
}

var timerclk = require("timerclk.lib.js");

var stopwatches = [], timers = [];
stopwatches = require("Storage").readJSON("timerclk.stopwatch.json") || [];
stopwatches = stopwatches.filter(e=>e.start||e.time);
timers = require("Storage").readJSON("timerclk.timer.json") || [];
timers = timers.filter(e=>e.start||e.timeAdd);

function isoStr(date) {
  return date.getFullYear() + "-" + ("0" + (date.getMonth() + 1)).slice(-2) + "-" + ("0" + date.getDate()).slice(-2);
}

// timeout used to update every minute
var drawTimeout;
var drawSpecialTimeout;

// schedule a draw for the next minute
function queueDraw(timeout, interval, func) {
  if (timeout) clearTimeout(timeout);
  timeout = setTimeout(function() {
    timeout = undefined;
    func();
  }, interval - (Date.now() % interval));
}

function drawSpecial() {
  var interval = 60000;
  var stopwatch = 0, timer = 0, time;
  var x = g.getWidth()/2;
  g.setColor(g.theme.fg);
  g.setFontAlign(0,0).setFont("HaxorNarrow", 1);
  var y = Bangle.appRect.y + g.stringMetrics("00:00").height/2;
  g.clearRect(Bangle.appRect.x, Bangle.appRect.y, Bangle.appRect.x2, Bangle.appRect.y+g.stringMetrics("00:00").height);
  if (stopwatches.length) {
    time = timerclk.getTime(stopwatches[stopwatch]);
    g.drawString(timerclk.formatTime(time, true), x, y);
    if (Math.floor(time/3600000) === 0) interval = 1000;
    stopwatch++;
  } else if (timers.length > 1) {
    time = timers[timer].time - timerclk.getTime(timers[timer]);
    g.drawString(timerclk.formatTime(time, true), x, y);
    if (Math.floor(time/3600000) === 0) interval = 1000;
    timer++;
  }

  if (timers.length) {
    time = timers[timer].time - timerclk.getTime(timers[timer]);
    g.drawString(timerclk.formatTime(time, true), x, y);
    if (Math.floor(time/3600000) === 0) interval = 1000;
  } else if (stopwatches.length > 1) {
    time = timerclk.getTime(stopwatches[stopwatch]);
    g.drawString(timerclk.formatTime(time, true), x, y);
    if (Math.floor(time/3600000) === 0) interval = 1000;
  }
  queueDraw(drawSpecialTimeout, interval, drawSpecial);
}

var drawCount=0;

function draw() {
  var x = g.getWidth()/2;
  var y = g.getHeight()/2;
  g.reset();
  var date = new Date();
  var timeStr = require("locale").time(date,1);
  var dateStr = isoStr(date);
  var dowStr = require("locale").dow(date).toUpperCase();
  
  // draw time
  g.setFontAlign(0,0).setFont("FiraSansCondensed");
  g.clearRect(Bangle.appRect.x, x-g.stringMetrics(timeStr).height/2, Bangle.appRect.x2, Bangle.appRect.y2); // clear the background
  g.drawString(timeStr,x,y);
  // draw date
  y += g.stringMetrics(timeStr).height/2;
  g.setFontAlign(0,0).setFont("HaxorNarrow", 1);
  y += g.stringMetrics(dateStr).height/2;
  g.drawString(dateStr,x,y);
  //draw day of week
  y += g.stringMetrics(dateStr).height/2;
  g.setFontAlign(0,0).setFont("HaxorNarrow", 1);
  y += g.stringMetrics(dowStr).height/2;
  g.drawString(dowStr,x,y);
  // queue draw in one minute
  queueDraw(drawTimeout, 60000, draw);
}

var absY, lastX, lastY;
Bangle.on('drag', e=>{
if (!e.b) {
  if (lastX > 50) { // right
    load("timerclk.timer.js");
  } else if (lastX < -50) { // left
    load("timerclk.stopwatch.js");
  } else if (lastY > 50) { // down
  } else if (lastY < -50) { // up
  }
  lastX = 0;
  lastY = 0;
} else {
  lastX = lastX + e.dx;
  lastY = lastY + e.dy;
  absY = e.y;
}
});

Bangle.setUI("clock"); // Show launcher when middle button pressed
g.clear();
Bangle.loadWidgets();
Bangle.drawWidgets();
draw();
if (stopwatches || timers) drawSpecial();
